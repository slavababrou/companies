import React, { useState, useEffect } from "react";
import styles from "./CompanyRevievItem.module.css";
import logo from "../../images/logo/logo.svg";
import TimeAgo from "../TimeAgo/TimeAgo";
import { useDispatch, useSelector } from "react-redux";
import { addLikeDislikeReviev } from "../../store/companySlice";
import { checkUserLikedDisliked } from "../../store/companySlice";

const ReviewItem = ({ reviev, user }) => {
  const dispatch = useDispatch();
  const currentUserId = useSelector((state) => state?.auth?.user?.user?.id);

  //только что бы ререндерить компонент и обновлтяь дату через UseEffect
  const [isAddedLike, setIsAddedLike] = useState(false);

  const [likeInfo, setLikeInfo] = useState({
    alreadyLikedOrDisliked: false,
    actionType: null,
  });

  useEffect(() => {
    // Вызываем thunk для проверки лайка/дизлайка
    if (currentUserId && reviev?.id)
      dispatch(
        checkUserLikedDisliked({ userId: currentUserId, revievId: reviev?.id })
      )
        .then((response) => {
          // Обновляем состояние в соответствии с результатами thunk
          setLikeInfo(response.payload);
          setIsAddedLike(false);
        })
        .catch((error) => {
          console.error("Error checking user liked or disliked:", error);
        });
  }, [dispatch, isAddedLike, reviev?.id, currentUserId]);

  const addLike = async (revievId) => {
    await dispatch(
      addLikeDislikeReviev({
        revievId,
        actionType: "like",
        userId: currentUserId,
      })
    );
    setIsAddedLike(true);
  };
  const addDislike = async (revievId) => {
    await dispatch(
      addLikeDislikeReviev({
        revievId,
        actionType: "dislike",
        userId: currentUserId,
      })
    );
    setIsAddedLike(true);
  };

  return (
    <div className={styles["list_item"]}>
      <div className={styles["list_item_logo-wrapper"]}>
        <img src={logo} alt='logo' />
        <TimeAgo date={reviev.date} />
      </div>
      <div className={styles["list_item_info"]}>
        <h5> {reviev.term}</h5>
        <span>Оценка: {reviev.raiting}</span>
        <span>{user?.login}</span>
      </div>
      <span className={styles["list_item_text"]}>{reviev.text}</span>
      <div className={styles["list_item_likes"]}>
        <button
          className={`${styles["likes"]} ${
            likeInfo?.alreadyLikedOrDisliked && likeInfo?.actionType === "like"
              ? styles["alredy-liked"]
              : ""
          }`}
          onClick={() => addLike(reviev.id)}
        >
          <svg
            version='1.1'
            width='25'
            height='22'
            viewBox='0 0 25 22'
            xmlns='http://www.w3.org/2000/svg'
            xmlnsXlink='http://www.w3.org/1999/xlink'
          >
            <path
              id='Like'
              d='M9.239,21.015 C9.061,21.692 8.677,21.999 8.024,21.999 C5.899,22.002 3.775,21.999 1.650,22.000 C1.207,22.000 0.818,21.851 0.468,21.590 C0.179,21.376 0.060,21.078 0.057,20.720 C0.039,18.755 0.005,16.790 -0.000,14.825 C-0.003,13.672 0.033,12.518 0.061,11.364 C0.083,10.443 0.858,9.694 1.771,9.695 C4.037,9.697 6.304,9.696 8.570,9.706 C8.766,9.706 8.900,9.651 9.007,9.492 C9.571,8.654 10.137,7.819 10.701,6.982 C10.911,6.670 11.093,6.335 11.332,6.049 C11.995,5.256 12.072,4.355 11.923,3.380 C11.827,2.755 11.782,2.121 11.746,1.489 C11.724,1.119 11.902,0.822 12.191,0.580 C13.103,-0.186 14.393,-0.197 15.449,0.580 C16.642,1.458 17.240,2.685 17.443,4.122 C17.620,5.376 17.441,6.605 17.120,7.818 C17.099,7.899 17.078,7.980 17.058,8.061 C17.055,8.077 17.058,8.094 17.058,8.143 C17.146,8.143 17.233,8.143 17.320,8.143 C19.120,8.142 20.920,8.142 22.719,8.141 C23.862,8.140 24.787,8.861 24.969,9.921 C25.099,10.671 24.812,11.300 24.321,11.844 C24.202,11.976 24.177,12.078 24.220,12.257 C24.449,13.208 24.189,14.060 23.632,14.831 C23.508,15.002 23.454,15.142 23.481,15.368 C23.597,16.337 23.357,17.221 22.769,18.009 C22.695,18.108 22.643,18.268 22.662,18.388 C22.936,20.101 21.735,21.160 20.342,21.281 C19.440,21.360 18.528,21.327 17.620,21.329 C15.254,21.334 12.888,21.327 10.522,21.333 C10.072,21.334 9.645,21.277 9.239,21.015 zM22.677,15.362 C22.562,15.362 22.464,15.362 22.366,15.362 C21.116,15.363 19.866,15.364 18.616,15.363 C18.466,15.363 18.313,15.374 18.167,15.347 C17.956,15.307 17.828,15.169 17.840,14.941 C17.852,14.717 17.980,14.590 18.201,14.565 C18.292,14.554 18.384,14.557 18.476,14.557 C19.859,14.558 21.242,14.560 22.626,14.555 C22.716,14.555 22.841,14.530 22.891,14.469 C23.358,13.894 23.601,13.250 23.458,12.493 C23.420,12.292 23.327,12.228 23.121,12.230 C21.804,12.239 20.487,12.235 19.170,12.234 C18.750,12.234 18.545,12.097 18.553,11.822 C18.561,11.557 18.755,11.432 19.167,11.432 C20.567,11.430 21.967,11.431 23.367,11.427 C23.464,11.427 23.580,11.426 23.654,11.377 C24.227,10.991 24.365,10.032 23.929,9.494 C23.605,9.095 23.175,8.943 22.671,8.944 C20.746,8.949 18.821,8.947 16.896,8.948 C16.124,8.948 16.037,8.840 16.227,8.097 C16.516,6.970 16.778,5.839 16.696,4.661 C16.619,3.563 16.289,2.562 15.542,1.735 C15.027,1.165 14.417,0.762 13.604,0.813 C12.859,0.861 12.480,1.272 12.542,2.003 C12.594,2.610 12.685,3.214 12.765,3.818 C12.881,4.703 12.691,5.509 12.170,6.238 C11.923,6.584 11.685,6.938 11.454,7.296 C10.777,8.349 10.146,9.434 9.307,10.373 C9.248,10.438 9.221,10.553 9.221,10.645 C9.216,13.698 9.216,16.751 9.219,19.804 C9.219,19.882 9.230,19.987 9.279,20.035 C9.553,20.299 9.859,20.523 10.261,20.523 C13.478,20.526 16.694,20.527 19.911,20.523 C20.395,20.522 20.852,20.403 21.257,20.125 C21.815,19.741 22.060,18.968 21.801,18.393 C20.750,18.393 19.692,18.394 18.634,18.393 C18.218,18.393 17.801,18.399 17.384,18.388 C17.157,18.381 16.996,18.215 16.999,18.007 C17.001,17.786 17.121,17.648 17.338,17.606 C17.418,17.590 17.503,17.590 17.586,17.590 C19.003,17.589 20.419,17.591 21.836,17.585 C21.941,17.584 22.089,17.556 22.144,17.484 C22.617,16.866 22.782,16.163 22.677,15.362 zM8.400,10.504 C8.277,10.504 8.171,10.504 8.065,10.504 C5.982,10.502 3.900,10.500 1.817,10.498 C1.286,10.498 0.861,10.899 0.860,11.431 C0.854,14.465 0.853,17.500 0.854,20.534 C0.855,20.919 0.921,21.006 1.289,21.129 C1.412,21.171 1.549,21.189 1.680,21.192 C2.088,21.200 2.496,21.195 2.904,21.196 C4.612,21.196 6.319,21.197 8.027,21.196 C8.334,21.196 8.413,21.115 8.414,20.811 C8.415,20.485 8.414,20.159 8.414,19.833 C8.414,16.824 8.414,13.814 8.414,10.804 C8.414,10.714 8.406,10.624 8.400,10.504 z'
              fill='#757575'
            />
          </svg>
          <span>{reviev.likes}</span>
        </button>
        <button
          className={`${styles["dislikes"]} ${
            likeInfo?.alreadyLikedOrDisliked &&
            likeInfo?.actionType === "dislike"
              ? styles["alredy-disliked"]
              : ""
          }`}
          onClick={() => addDislike(reviev.id)}
        >
          <svg
            version='1.1'
            width='25'
            height='22'
            viewBox='0 0 25 22'
            xmlns='http://www.w3.org/2000/svg'
            xmlnsXlink='http://www.w3.org/1999/xlink'
          >
            <path
              id='Dislike'
              d='M9.224,0.980 C9.828,0.555 10.519,0.673 11.186,0.671 C14.050,0.664 16.914,0.671 19.778,0.669 C20.346,0.669 20.889,0.770 21.399,1.028 C22.339,1.502 22.836,2.459 22.668,3.503 C22.634,3.713 22.660,3.868 22.797,4.049 C23.398,4.848 23.610,5.753 23.473,6.746 C23.459,6.844 23.496,6.974 23.556,7.055 C24.182,7.895 24.476,8.805 24.201,9.855 C24.183,9.926 24.234,10.041 24.289,10.104 C24.676,10.540 24.961,11.024 24.995,11.619 C25.063,12.823 24.077,13.847 22.827,13.854 C21.007,13.864 19.187,13.857 17.367,13.857 C17.267,13.857 17.168,13.857 17.036,13.857 C17.129,14.265 17.226,14.649 17.302,15.037 C17.574,16.410 17.622,17.779 17.125,19.116 C16.688,20.292 15.985,21.259 14.797,21.770 C13.841,22.182 12.942,22.060 12.130,21.382 C11.867,21.163 11.717,20.885 11.727,20.555 C11.743,20.006 11.795,19.457 11.842,18.909 C11.877,18.485 11.936,18.063 11.966,17.638 C11.995,17.225 11.882,16.834 11.658,16.494 C10.792,15.185 9.911,13.885 9.037,12.581 C8.903,12.382 8.746,12.291 8.483,12.292 C6.229,12.309 3.974,12.304 1.720,12.308 C0.826,12.309 0.026,11.550 0.020,10.649 C0.003,7.855 -0.001,5.062 -0.007,2.269 C-0.008,1.917 0.014,1.566 0.018,1.215 C0.023,0.807 0.225,0.519 0.559,0.313 C0.877,0.117 1.221,-0.001 1.599,-0.001 C3.753,-0.001 5.908,-0.004 8.062,0.001 C8.650,0.002 8.993,0.295 9.224,0.980 zM21.819,3.618 C22.045,2.854 21.758,2.146 21.093,1.776 C20.607,1.505 20.080,1.470 19.541,1.471 C17.745,1.476 15.950,1.473 14.155,1.473 C12.861,1.474 11.567,1.475 10.273,1.475 C9.879,1.475 9.541,1.645 9.307,1.929 C9.188,2.074 9.195,2.346 9.194,2.561 C9.187,5.354 9.194,8.148 9.181,10.942 C9.179,11.328 9.215,11.664 9.533,11.925 C9.628,12.003 9.699,12.113 9.768,12.217 C10.460,13.251 11.157,14.282 11.836,15.324 C12.117,15.756 12.409,16.193 12.606,16.665 C12.913,17.403 12.751,18.178 12.657,18.942 C12.595,19.447 12.553,19.954 12.529,20.462 C12.523,20.573 12.607,20.722 12.696,20.798 C13.242,21.264 13.859,21.306 14.499,21.027 C15.254,20.698 15.756,20.104 16.131,19.393 C16.580,18.542 16.709,17.626 16.692,16.674 C16.674,15.660 16.402,14.694 16.167,13.720 C16.049,13.232 16.179,13.056 16.671,13.055 C18.683,13.053 20.695,13.055 22.707,13.054 C23.326,13.054 23.820,12.815 24.089,12.239 C24.349,11.683 24.146,11.192 23.782,10.760 C23.704,10.668 23.548,10.595 23.427,10.593 C22.392,10.581 21.357,10.587 20.322,10.587 C19.904,10.587 19.487,10.588 19.069,10.584 C18.739,10.580 18.539,10.422 18.544,10.177 C18.548,9.926 18.736,9.786 19.078,9.779 C19.111,9.779 19.144,9.779 19.178,9.779 C20.489,9.779 21.799,9.773 23.110,9.785 C23.337,9.787 23.421,9.706 23.459,9.501 C23.598,8.745 23.357,8.100 22.888,7.525 C22.842,7.469 22.725,7.450 22.642,7.449 C21.932,7.444 21.222,7.447 20.512,7.447 C19.761,7.447 19.010,7.446 18.258,7.446 C18.050,7.447 17.899,7.357 17.841,7.157 C17.789,6.980 17.841,6.812 18.006,6.724 C18.111,6.669 18.244,6.645 18.365,6.645 C19.717,6.640 21.070,6.642 22.423,6.642 C22.503,6.641 22.584,6.633 22.658,6.629 C22.793,6.000 22.630,5.241 22.265,4.670 C22.151,4.491 22.025,4.414 21.802,4.416 C20.374,4.428 18.946,4.422 17.518,4.423 C17.187,4.423 16.993,4.280 16.983,4.028 C16.974,3.766 17.165,3.620 17.522,3.619 C17.823,3.618 18.123,3.618 18.424,3.618 C19.550,3.618 20.677,3.618 21.819,3.618 zM8.386,6.184 C8.386,6.184 8.386,6.184 8.387,6.184 C8.387,4.537 8.386,2.890 8.387,1.244 C8.387,0.870 8.328,0.805 7.952,0.805 C6.341,0.803 4.731,0.803 3.120,0.803 C2.603,0.803 2.082,0.765 1.569,0.814 C0.988,0.870 0.798,1.000 0.801,1.560 C0.818,4.544 0.809,7.528 0.817,10.512 C0.819,11.131 1.222,11.505 1.846,11.505 C3.924,11.502 6.002,11.493 8.079,11.503 C8.349,11.504 8.392,11.412 8.390,11.174 C8.381,9.511 8.386,7.847 8.386,6.184 z'
              fill='#757575'
            />
          </svg>

          <span>{reviev.dislikes}</span>
        </button>
      </div>
    </div>
  );
};

export default ReviewItem;
